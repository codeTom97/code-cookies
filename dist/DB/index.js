"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function r(e,s){for(var t=0;t<s.length;t++){var r=s[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,s,t){return s&&r(e.prototype,s),t&&r(e,t),e}}();function _classCallCheck(e,s){if(!(e instanceof s))throw new TypeError("Cannot call a class as a function")}var CodeDB=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"code_db",s=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1;_classCallCheck(this,t),this.dbName=e||"code_db",this.version=s,this.isOpenDB=!1,this.opendb="",this.idbRequest="",this.errorMsg={status:"error",msg:"no msg"},this.successMsg={status:"success",msg:"success msg"}}return _createClass(t,[{key:"openDb",value:function(n){var o=this,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"id",u=arguments[2];return new Promise(function(r,e){o.isOpenDB&&(o.errorMsg.msg="数据库已经开启，切勿频繁打开",e(o.errorMsg)),o.opendb||(o.opendb=indexedDB.open(o.dbName,o.version)),o.opendb.onupgradeneeded=function(e){var s=e.target;if(o.isOpenDB=!0,"done"===s.readyState){if(o.idbRequest=s.result,!o.idbRequest.objectStoreNames.contains(n)){var t=o.idbRequest.createObjectStore(n,{keyPath:i});u.forEach(function(e){t.createIndex(e.name,e.name,{unique:e.isUnique})})}o.successMsg.msg="数据库更新成功",r(o.successMsg)}},o.opendb.onsuccess=function(e){var s=e.target;o.isOpenDB=!0,"done"===s.readyState&&(o.idbRequest=s.result,r(o.idbRequest))},o.opendb.onerror=function(){o.errorMsg.msg="数据库异常，请刷新浏览器重试",e(o.errorMsg)}})}},{key:"setDbItem",value:function(e,s){var r=this;if(this.version===this.idbRequest.version){var n=this.idbRequest.transaction([e],"readwrite").objectStore(e).add(s);return new Promise(function(s,t){n.onsuccess=function(e){r.successMsg.msg="写入成功",s(r.successMsg)},n.onerror=function(e){e.isTrusted?(r.errorMsg.msg="写入失败: 已经存在数据",t(r.errorMsg)):t(e)}})}}},{key:"putDbItem",value:function(e,s){var r=this;if(this.version===this.idbRequest.version){var n=this.idbRequest.transaction([e],"readwrite").objectStore(e).put(s);return new Promise(function(s,t){n.onsuccess=function(e){r.successMsg.msg="更新成功",s(r.successMsg)},n.onerror=function(e){e.isTrusted?(r.errorMsg.msg="更新失败: 数据已经存在",t(r.errorMsg)):t(e)}})}}},{key:"getDbItem",value:function(e,s){if(this.version===this.idbRequest.version){var r="",n=this.idbRequest.transaction([e]).objectStore(e).get(s);return new Promise(function(s,t){n.onsuccess=function(e){r=e.target.result,s(r)},n.onerror=function(e){e.isTrusted?t("数据不存在"):t(e)}})}}},{key:"delDbItem",value:function(e,s){var r=this;if(this.version===this.idbRequest.version){var n=this.idbRequest.transaction([e],"readwrite").objectStore(e).delete(s);return new Promise(function(s,t){n.onsuccess=function(e){r.successMsg.msg="删除成功",s(r.successMsg)},n.onerror=function(e){r.errorMsg.msg="删除失败",t(r.errorMsg)}})}}}]),t}();exports.default=CodeDB;